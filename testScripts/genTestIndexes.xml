<project
    name="Helper targets"
    default="generateEclipseIndex"
    basedir=".">

    <target name="init" depends="initStreamVariables" unless="genTestIndexesInitialized">
        <fail unless="buildId" />
        <fail unless="eclipseStream" />

    <script language="javascript">
        var buildId = project.getProperty("buildId");
        var pattern = new RegExp(/^([IMNSR])(\d{8})-(\d{4})$/);

        var sArray = pattern.exec(buildId);
        // sArray 0 is "whole match"
        project.setProperty("buildType", sArray[1]);
    </script>
    
     <!-- 
        TODO: make less exactly hard coded in future
         also, check for validity using "matches" digit*\.digit*\.digit*
      -->
        <condition
            property="dropsDirSegment"
            value="drops4"
            else="drops">
            <equals
                arg1="${eclipseStreamMajor}"
                arg2="4" />
        </condition>

        <property
            name="buildRoot"
            value="/shared/eclipse/eclipse${eclipseStreamMajor}${buildType}" />


        <property
            name="postingDirectory"
            value="${buildRoot}/siteDir/eclipse/downloads/${dropsDirSegment}" />
        <property
            name="builderDir"
            value="${buildRoot}/build/supportDir/org.eclipse.releng.eclipsebuilder" />
        <property
            name="publishingContent"
            value="${buildRoot}/build/supportDir/org.eclipse.releng.eclipsebuilder/eclipse/publishingFiles" />
        <property
            name="base.builder"
            value="${buildRoot}/build/supportDir/org.eclipse.releng.basebuilder" />

        <property
            name="buildLabel"
            value="${buildId}" />
        <property
            name="eclipse.build.configs"
            value="${builderDir}/eclipse/buildConfigs" />
        <property
            name="buildDirectory"
            value="${basedir}/../src" />

        <property name="genTestIndexesInitialized" value="true"/>
        
                
    </target>

    <target name="generateEclipseIndex" depends="init" >
        <condition
            property="generatorClass"
            value="org.eclipse.releng.generators.EclipseTestResultsGeneratorNoMail">
            <equals
                arg1="${hudson}"
                arg2="true" />
        </condition>
        <property
            name="generatorClass"
            value="org.eclipse.releng.generators.EclipseTestResultsGenerator" />

        <available
            classname="${generatorClass}"
            property="class"
            value="${generatorClass}" />
        
        <!--regenerate the index page with links to test results -->
        <ant
            antfile="${builderDir}/eclipse/helpernew.xml"
            dir="${publishingContent}"
            target="generateEclipseIndex">

            <property
                name="isBuildTested"
                value="true" />
            <property
                name="buildType"
                value="${buildType}" />
            <property
                name="dropTokenList"
                value="%sdk%,%tests%,%example%,%rcpruntime%,%rcpsdk%,%deltapack%,%icubase%,%runtime%,%jdt%,%jdtsdk%,%jdtc%,%jarprocessor%,%pde%,%pdesdk%,%cvs%,%cvssdk%,%swt%,%relengtools%" />
            <property
                name="platformIdentifierToken"
                value="%platform%" />
            <property
                name="platformSpecificTemplateList"
                value="Windows,${publishingContent}/templateFiles/platform.php.template,winPlatform.php;Linux,${publishingContent}/templateFiles/platform.php.template,linPlatform.php;Solaris,${publishingContent}/templateFiles/platform.php.template,solPlatform.php;AIX,${publishingContent}/templateFiles/platform.php.template,aixPlatform.php;Macintosh,${publishingContent}/templateFiles/platform.php.template,macPlatform.php;HP-UX,${publishingContent}/templateFiles/platform.php.template,hpuxPlatform.php" />
            <property
                name="indexFileName"
                value="index.php" />
            <property
                name="result"
                value="${postingDirectory}/${buildId}" />
            <property
                name="testResultsTemplateFileName"
                value="${publishingContent}/templateFiles/testResults.php.template" />
            <property
                name="dropTemplateFileName"
                value="${publishingContent}/templateFiles/index.php.template" />
            <property
                name="testManifestFileName"
                value="${publishingContent}/testManifest.xml" />
        </ant>

    </target>

    <target name="initStreamVariables">

        <fail
            unless="eclipseStream"
            message="eclipseStream must be provided by caller" />
        <condition property="streamOK">
            <matches
                pattern="\d\.\d\.\d"
                string="${eclipseStream}" />
        </condition>
        <fail
            message="eclipseStream variable had unexpected format. Should be digit.digit.digit, but was ${eclipseStream}"
            unless="streamOK" />
        <script language="javascript">
            var eclipseStream = project.getProperty("eclipseStream");
            var pattern = new
            RegExp(/(\d+)\.(\d+)\.(\d+)/);

            var sArray = pattern.exec(eclipseStream);
            // sArray[0] is "whole match"
            project.setProperty("eclipseStreamMajor", sArray[1]);
            project.setProperty("eclipseStreamMinor", sArray[2]);
            project.setProperty("eclipseStreamService", sArray[3]);

        </script>

    </target>

</project>
