<project name="Eclipse Test Configuration" default="JUnitTests" basedir=".">

	<!--
	Ant properties for buildId, buildLabel, timestamp and buildDirectory must be set before running this script.
-->
	<property name="markerContainer" value="/home/users/releng/buildTools/markers" />
	<property name="cfg" value="${markerContainer}/machine.cfg" />
	<property name="test.xml" value="${base.builder}/plugins/org.eclipse.build.tools/scripts/test.xml" />
	
	<target name="test">
		<property name="sleep" value="0"/>
		<findMachine cfg="${cfg}" markerContainer="${markerContainer}" cfgKey="${cfgKey}" markerName="${markerName}" waitInterval="30" />
		<property file="${markerContainer}/${markerName}.marker" />
		<property name="testMachine" value="${0}" />
		<sleep seconds="${sleep}"/>
		<ant antfile="${test.xml}"/>
		<delete file="${markerContainer}/${markerName}.marker" />
	</target>

	<target name="JUnitTests">
		<parallel>
			<antcall target="test">
				<param name="tester" value="${basedir}/macosx-carbon" />
				<param name="cfgKey" value="eclipse31MacOSXCarbonTest" />
				<param name="markerName" value="eclipse31-macosx-carbon-${buildId}" />
			</antcall>
			 <antcall target="test">
				<param name="tester" value="${basedir}/rhelws4-linux-gtk" />
				<param name="cfgKey" value="eclipse32LinuxGtkTest" />
				<param name="markerName" value="eclipse32-linux-gtk-${buildId}" />
			</antcall> 
			<antcall target="test">
				<param name="tester" value="${basedir}/win32" />
				<param name="cfgKey" value="eclipse30WinXPTest" />
				<param name="markerName" value="eclipse31-winxp-${buildId}" />
			</antcall>
			 <antcall target="test">
				<param name="tester" value="${basedir}/rhelws4-linux-gtk-5.0" />
				<param name="cfgKey" value="eclipse32LinuxGtkTest50" />
				<param name="markerName" value="eclipse32-5.0-linux-gtk-${buildId}" />
			</antcall> 
			<!--antcall target="test">
				<param name="tester" value="${basedir}/win32-5.0" />
				<param name="cfgKey" value="eclipse32WinXPTest50" />
				<param name="markerName" value="eclipse32-5.0-winxp-${buildId}" />
			</antcall-->

		</parallel>
	</target>

	<target name="performanceTests">
		
		<condition property="internalPlugins" value="../../../eclipsePerformanceBuildTools/plugins">
			<isset property="performance.base"/>
		</condition>

		<property name="testResults" value="${postingDirectory}/${buildLabel}/performance" />
		<mkdir dir="${testResults}" />

		<parallel>
			<!--slow machines-->
			<antcall target="test">
				<param name="tester" value="${basedir}/win32-perf" />
				<param name="cfgKey" value="eclipse30WinXPTestPerf" />
				<param name="markerName" value="eclipse30-winxp-perf-${timestamp}" />
			</antcall>
			<antcall target="test">
				<param name="tester" value="${basedir}/rhelws3-linux-gtk-perf" />
				<param name="cfgKey" value="eclipse30LinuxGtkTestPerf" />
				<param name="markerName" value="eclipse30-linux-gtk-perf-${timestamp}" />
			</antcall>
			<!--fast machines-->
			<antcall target="test">
				<param name="tester" value="${basedir}/win32-perf2" />
				<param name="sleep" value="240" />
				<param name="cfgKey" value="eclipse30WinXPTestPerf2" />
				<param name="markerName" value="eclipse30-winxp-perf2-${timestamp}" />
			</antcall>
			<antcall target="test">
				<param name="tester" value="${basedir}/rhelws3-linux-gtk-perf2" />
				<param name="sleep" value="120" />
				<param name="cfgKey" value="eclipse30LinuxGtkTestPerf2" />
				<param name="markerName" value="eclipse30-linux-gtk-perf2-${timestamp}" />
			</antcall>
			<antcall target="test">
				<param name="tester" value="${basedir}/rhelws4-linux-gtk-perf" />
				<param name="sleep" value="300" />
				<param name="cfgKey" value="eclipse31LinuxGtkTestPerf3" />
				<param name="markerName" value="eclipse31-linux-gtk-perf3-${timestamp}" />
			</antcall>
		</parallel>
	</target>
</project>