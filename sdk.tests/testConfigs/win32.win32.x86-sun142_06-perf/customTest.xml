
<project name="Customized testing instructions" default="customSetup">

	<target name="customSetup">

		<!--property file containing key value pair for ${eclipse.perf.ref}-->
		<property file="${ref.properties}" />
				
		<antcall target="installVm" />
		<!--copy the script which sets up environment and invokes the tests on test machine-->
		<exec dir="." executable="${copyClient}">
			<arg line="${tester}/testAll.bat ${testMachine}:${executionDir}" />
		</exec>
		
		<!--copy in test script modified for running Team CVS tests-->
		<exec dir="." executable="${copyClient}">
			<arg line="${tester}/../../testScripts/test.xml ${testMachine}:${executionDir}" />
		</exec>
		
		<replace file="${tester}/vm.properties" token="@buildType@@timestamp@" value="${buildId}"/>
		<replace file="${tester}/vm.properties" token="@reference@" value="${eclipse.perf.ref}"/>
		
		<!--copy in the properties file for testing with J9 vm args-->	
		<exec dir="." executable="${copyClient}">
			<arg line="${tester}/vm.properties ${testMachine}:${executionDir}" />
		</exec>
		
		<!--add Cloudscape to junit tests unless rebuilt zip already exists-->
		<available property="cloudscape.installed" file="${tester}/../eclipse-junit-tests-${buildId}.zip" />
		<antcall target="installCloudscape" />
		
	</target>

	<target name="installCloudscape" unless="cloudscape.installed">
		<unzip dest="${tester}/..">
			<patternset>
				<include name="**/eclipse-junit-tests*.zip" />
			</patternset>
			<fileset dir="${postingDirectory}/${buildId}">
				<include name="eclipse-Automated-Tests-*.zip" />
			</fileset>
		</unzip>
		<zip destfile="${tester}/../eclipse-junit-tests-${buildId}.zip" update="true">
			<zipgroupfileset dir="${tester}/../eclipse-testing" includes="eclipse-junit-tests-${buildId}.zip"/>
			<zipfileset dir="${internalPlugins}" includes="Cloudscape/**" prefix="eclipse/plugins" />
		</zip>
		<exec dir="${tester}/../eclipse-testing" executable="${copyClient}">
			<arg line="eclipse-junit-tests-${buildId}.zip ${testMachine}:${executionDir}" />
		</exec>
	</target>
	
	<target name="installVm">
		<property name="testVmTag" value="HEAD" />
		<!--get and install the vm to test with-->
		<cvs cvsRoot="${cvsRoot}"
        	 command="export -r ${testVmTag} ${vmUrl}"
        	 dest="${tester}"
  		/>
  		
		<exec dir="${tester}" executable="${copyClient}">
			<arg line="${vmUrl} ${testMachine}:${testDir}" />
		</exec>
		<exec dir="." executable="${loginClient}">
			<arg line="${testMachine} ${vmInstallCommand}" />
		</exec>
	</target>
</project>