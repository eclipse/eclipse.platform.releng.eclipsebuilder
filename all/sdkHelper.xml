<project name="SDK/Platform specific helper targets" default="noDefault">
	<property name="postingDirectory" value="${buildDirectory}" />
	<!-- ===================================================================== -->
	<!-- Set of helper targets for building the Eclipse SDK -->
	<!-- ===================================================================== -->
	<target name="discoverOS">
		<condition property="onUnix">
			<and>
				<os family="unix" />
			</and>
		</condition>
		<condition property="onWindows">
			<and>
				<os family="windows" />
			</and>
		</condition>
	</target>

	<target name="printWarnings" if="onWindows" depends="discoverOS">
		<echo message="The UNIX versions of your build output will be invalid.  Windows will not preserve symbolic links and permissions on executable files." />
	</target>

	<target name="setLabels">
		<!--required-->
		<!-- setup the label.properties file packaged in the source builds. -->
		<!--Set this property to empty string-->
		<property name="buildType" value="" />
		<tstamp>
			<format property="TODAY" pattern="MMMM d, yyyy" />
			<format property="TSTAMP" pattern="HHmm" />
		</tstamp>
		<copy file="label.properties.template" tofile="${buildDirectory}/label.properties" overwrite="true" />
		<replace file="${buildDirectory}/label.properties" token="@builddate@" value="${TODAY}" />
		<replace file="${buildDirectory}/label.properties" token="@buildtype@" value="${buildType}" />
		<replace file="${buildDirectory}/label.properties" token="@ds@" value="${timestamp}" />
		<replace file="${buildDirectory}/label.properties" token="@buildid@" value="${buildId}" />
	</target>



	<!-- ===================================================================== -->
	<!-- Targets related to publishing the build.  These targets are typically -->
	<!-- called from the org.eclipse.releng.basebuilder/publish.xml            -->
	<!-- ===================================================================== -->
	<target name="buildStandAloneSWT">
		<!--where SWT zip files are created-->
		<property name="destination" value="${postingDirectory}/${buildLabel}" />
		<property name="baseLocation" value="" />
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.win32.win32.x86">
			<!--property name="os" value="win32" />
		<property name="ws" value="win32" />
		<property name="arch" value="x86" /-->
		</ant>

		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.motif.linux.x86">
			<property name="os" value="linux" />
			<property name="ws" value="motif" />
			<property name="arch" value="x86" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.motif.aix.ppc">
			<property name="os" value="aix" />
			<property name="ws" value="motif" />
			<property name="arch" value="ppc" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.motif.hpux.PA_RISC">
			<property name="os" value="hpux" />
			<property name="ws" value="motif" />
			<property name="arch" value="PA_RISC" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.motif.solaris.sparc">
			<property name="os" value="solaris" />
			<property name="ws" value="motif" />
			<property name="arch" value="sparc" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.gtk.solaris.sparc">
			<property name="os" value="solaris" />
			<property name="ws" value="gtk" />
			<property name="arch" value="sparc" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.photon.qnx.x86">
			<property name="os" value="qnx" />
			<property name="ws" value="photon" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.gtk.linux.x86">
			<property name="os" value="linux" />
			<property name="ws" value="gtk" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.carbon.macosx.ppc">
			<property name="os" value="macosx" />
			<property name="ws" value="carbon" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.gtk.linux.x86_64">
			<property name="os" value="linux" />
			<property name="ws" value="gtk" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.gtk.linux.ppc">
					<property name="os" value="linux" />
					<property name="ws" value="gtk" />
		</ant>
		
		<!--need to check out -->
		<property name="featureOnly" value="false"/>
		<property name="featureAndPlugins" value="true"/>
		<property name="featuresRecursively" value="false"/>
		<ant antfile="genericTargets.xml" dir="${pde.build.scripts}" target="fetchElement">
			<property name="type" value="fragment" />
			<property name="id" value="org.eclipse.swt.win32.wce_ppc.arm" />
		</ant>
		<ant antfile="build.xml" target="swtdownload" dir="${buildDirectory}/plugins/org.eclipse.swt.win32.wce_ppc.arm">
		</ant>
	</target>

	<target name="publish" description="Preparing to post the build...">
		<!-- required -->

		<antcall target="buildStandAloneSWT" />

		<!--post clickThroughs-->
		<copy todir="${postingDirectory}/${buildLabel}">
			<fileset dir="${buildDirectory}/maps/org.eclipse.releng" includes="clickThroughs/" />
		</copy>

		<!--post directory.txt-->
		<copy file="${buildDirectory}/directory.txt" todir="${postingDirectory}/${buildLabel}" />

		<!--post instructions on automated testing-->
		<copy file="${eclipse.build.scripts}/sdk.tests/testScripts/readme.html" tofile="${postingDirectory}/${buildLabel}/automatedtesting.html" />
		<copy file="${buildDirectory}/plugins/org.eclipse.test/testframework.html" tofile="${postingDirectory}/${buildLabel}/testframework.html" />

		<antcall target="generateEclipseIndex" />
		<ant antfile="publish.xml" target="getStaticFiles" />
		<antcall target="generateMD5Checksum" />
	</target>


	<!-- ===================================================================== -->
	<!-- Target used to test the build                                         -->
	<!-- ===================================================================== -->
	<target name="test">
		<echo message="Starting tests." />
		<property name="dropLocation" value="${postingDirectory}" />
		<ant antfile="testAll.xml" dir="${eclipse.build.scripts}/sdk.tests/testConfigs" />

		<antcall target="generateEclipseIndex" />

		<!--copy the test results and new index page to the posting location-->
		<copy todir="${postingDirectory}/${buildLabel}" overwrite="true">
			<fileset dir="${buildDirectory}/${buildLabel}" includes="testresults/**,*.php" />
		</copy>
		<replace file="${postingDirectory}/${buildLabel}/testResults.php" token="@build@" value="${buildId}" />

	</target>

	<!-- ===================================================================== -->
	<!-- Target used to test the build                                         -->
	<!-- ===================================================================== -->
	<target name="test-performance" unless="skip.performance.tests">
		<echo message="Starting performance tests." />
		<property name="dropLocation" value="${postingDirectory}" />
		<ant antfile="testAll.xml" dir="${eclipse.build.scripts}/sdk.tests/testConfigs" target="performanceTests"/>
		<antcall target="generatePerformanceResults" >
			<param name="configList" value="eclipseperfwin1_R3.2,eclipseperflnx1_R3.2,eclipseperfwin2_R3.2,eclipseperflnx2_R3.2" />
		</antcall>
	</target>

	<!-- ===================================================================== -->
	<!-- Target used to test the build for internal references                 -->
	<!-- ===================================================================== -->
	<target name="test-internalReferences">
		<property name="apiscanner" value="${eclipse.build.scripts}/sdk/tools/apiscanner" />
		<property name="workingDir" value="${buildDirectory}/internalReference" />
		<mkdir dir="${workingDir}"/>
		<unzip src="${postingDirectory}/${buildLabel}/eclipse-SDK-${buildId}-win32.zip" dest="${workingDir}" />

		<java classname="org.eclipse.wtp.releng.tools.component.violation.ComponentViolationEmitter" fork="true" dir="${apiscanner}">
			<arg line="
         	-eclipseDir ${workingDir}/eclipse
         	-compXMLDir ${buildDirectory}/plugins
         	-compRefDir component-ref
         	-compVioDir ${postingDirectory}/${buildLabel}/internalReference
         	-xsl xsl/component-violation.xsl
         	-summaryXSL xsl/component-violation-summary.xsl"/>
			<classpath>
				<fileset dir="${apiscanner}/lib"/>
			</classpath>
		</java>
	</target>

	<!-- ===================================================================== -->
	<!-- Helper targets                                                        -->
	<!-- ===================================================================== -->
	<target name="mail" unless="noMail">
		<!-- helper target for sending email messages related to build. -->
		<mail mailhost="${host}" from="${sender}" tolist="${recipients}" subject="[eclipse-build] ${buildId}: ${subject}" message="${message}" failonerror="false" />
	</target>

	<target name="configure.team.cvs.test" unless="test.xml.tmp">
		<copy file="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml" tofile="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml.tmp" />
		<replace file="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml" token="@cvs_user@" value="cvstests" />
		<replace file="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml" token="@cvs_password@" value="goteam4e" />
		<replace file="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml" token="@cvs_host@" value="fiji" />
		<replace file="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml" token="@cvs_root@" value="/home/sdimitro/repo" />
		<delete file="${eclipse.build.scripts}/sdk.tests/testScripts/test.xml.tmp" />
	</target>
	
	<target name="generateEclipseIndex">
		<available classname="org.eclipse.releng.generators.EclipseTestResultsGenerator" property="class" value="org.eclipse.releng.generators.EclipseTestResultsGenerator" />
		<!--property name="class" value="org.eclipse.releng.generators.TestResultsGenerator" /-->

		<!--regenerate the index page with links to test results-->
		<ant antfile="publish.xml" target="generateIndex">
			<property name="isBuildTested" value="true" />
			<property name="dropTokenList" value="%sdk%,%tests%,%example%,%rcpruntime%,%rcpsdk%,%runtime%,%platformsdk%,%jdt%,%jdtsdk%,%pde%,%pdesdk%,%teamextras%,%swt%,%relengtools%" />
		</ant>
		<!--  Insert ftp url for drop directory  -->
		<replace file="${postingDirectory}/${buildLabel}/index.php" token="@buildlabel@" value="${buildLabel}" />
	</target>

	<target name="generatePerformanceResults">
		<mkdir dir="${buildDirectory}/${buildLabel}/performance"/>
		<mkdir dir="${postingDirectory}/${buildLabel}/performance"/>

		<taskdef name="performanceResults" classname="org.eclipse.releng.performance.PerformanceResultHtmlGenerator" />
		<ant antfile="extraTargets.xml" target="generatePerformanceResults">
			<property name="baseline" value="${eclipse.perf.ref}" />
			<property name="jvm" value="${eclipse.perf.jvm}" />
			<property name="fp.output" value="${postingDirectory}/${buildLabel}/performance/" />
			<property name="config" value="${configList}" />
			<property name="config.properties" value="${eclipse.perf.config.descriptors}" />
			<property name="scenario.filter" value="org.eclipse.%.test" />
		</ant>
			
		<performanceResults xmlDirectoryName="${postingDirectory}/${buildLabel}/performance/xml" dropDirectoryName="${postingDirectory}/${buildLabel}" testResultsTemplateFileName="${basedir}/templateFiles/performance.php.template" testResultsHtmlFileName="performance/performance.php" hrefTestResultsTargetPath="html" testManifestFileName="${basedir}/performanceTestManifest.xml" />
		<replace file="${postingDirectory}/${buildLabel}/performance/performance.php" token="@buildType@" value="${buildType}" />
	</target>

	<target name="generateMD5Checksum">
		<!--use attached script instead of Ant checksum task so that files are properly formatted
		for command md5sum -c <filename>.md5
		-->
		<mkdir dir="${postingDirectory}/${buildLabel}/checksum" />
		<exec dir="${postingDirectory}/${buildLabel}" executable="sh" os="Linux">
			<arg line="${basedir}/produceChecksum" />
		</exec>
	</target>

	<target name="verifyCompile" if="eclipse.running">
		<property file="${basedir}/monitor.properties" />
		<echo message="Checking for compile errors..." />
		<!-- Sends email to recipient list in monitor.properties with compile logs attached if errors found-->
		<verifyCompile install="${postingDirectory}/${buildLabel}/compilelogs" />
	</target>

	<!-- ===================================================================== -->
	<!-- Default target                                                        -->
	<!-- ===================================================================== -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>
</project>
