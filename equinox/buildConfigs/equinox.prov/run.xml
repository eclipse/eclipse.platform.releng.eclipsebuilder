<project name="provisioning build" default="build">

	<!--
		- Build the agent product. (win32)
		- Build the metadata generator. (linux)
		- Run the metadata generator on the agent. 
		- Build the director. (linux)
		- Run the director and install a new agent.
		- Zip up the agent.
		- Build the self-hosting feature. (win32)
		- Run the metadata generator on the self-hosting feature.
		- Run the metadata generator on the Eclipse SDK.
	-->
	<target name="init">
		<!-- TODO: pass these arguments in -->
		<property name="prov.root" value="${buildDirectory}/${buildId}/provtemp" />
		<mkdir dir="${prov.root}" />
		<property name="prov.output.base" value="${prov.root}/equinox.p2.build" />
		<mkdir dir="${prov.output.base}" />

		<property name="sdk.archive" value="${postingDirectory}/${buildLabel}/eclipse-SDK-${buildId}-linux-gtk-ppc.tar.gz" />
		<property name="rcp.delta.archive" value="${postingDirectory}/${buildLabel}/eclipse-RCP-${buildId}-delta-pack.zip" />
		<property name="rcp.archive" value="${postingDirectory}/${buildLabel}/eclipse-RCP-${buildId}-linux-gtk-ppc.tar.gz" />
		<property name="rcp.win32.archive" value="${postingDirectory}/${buildLabel}/eclipse-RCP-${buildId}-linux-gtk-ppc.tar.gz" />

		<property name="prov.install.folder.parent" value="${prov.root}/" />
		<property name="prov.install.folder" value="equinox.prov" />
		<property name="prov.install.path" value="${prov.install.folder.parent}${prov.install.folder}" />

		<property name="base" value="${prov.output.base}/base" />
		<mkdir dir="${base}" />
		<property name="prov.install.path" value="${prov.output.base}${prov.install.folder}" />
		<mkdir dir="${prov.install.path}" />

		<property file="build.properties" />

		<property name="prov.agent.dir" value="${prov.output.base}/agent" />
		<mkdir dir="${prov.agent.dir}" />
		<property name="prov.generator.dir" value="${prov.output.base}/generator" />
		<mkdir dir="${prov.generator.dir}" />
		<property name="prov.repo.root" value="${prov.output.base}/servers" />
		<mkdir dir="${prov.metadata.repo}" />
		<property name="prov.metadata.repo" value="${prov.repo.root}/metadataRepository/" />
		<mkdir dir="${prov.metadata.repo}" />
		<property name="prov.artifact.repo" value="${prov.repo.root}/artifactRepository/" />
		<mkdir dir="${prov.artifact.repo}" />
		<property name="prov.flavor" value="tooling" />
	</target>

	<target name="build" depends="init">
		<!-- Ensure that we are building against the same version that we
			are generating the metadata for -->
		<antcall target="extract">
			<param name="extract-src" value="${sdk.archive}" />
			<param name="extract-dest" value="${base}" />
		</antcall>
		<antcall target="extract">
			<param name="extract-src" value="${rcp.delta.archive}" />
			<param name="extract-dest" value="${base}" />
		</antcall>
		<antcall target="build.features" />
		<!-- Generate the metadata for the agent and create the install first due
			to bug 199317... installing will install all fragments and we don't want the
			ones from the SDK -->
		<antcall target="generate.metadata.agent" />
		<antcall target="run.director" />
		<antcall target="generate.metadata.selfhosting" />
		<antcall target="generate.metadata.userUI" />
		<antcall target="generate.metadata.sdk" />
		<antcall target="zip.install" />
	</target>

	<target name="build.features">
		<ant antfile="${eclipse.pdebuild.scripts}/build.xml">
			<property name="builder" value="${basedir}" />
		</ant>
	</target>

	<target name="generate.metadata.agent">
		<!-- prepare the generator application -->
		<path id="feature.zip.path">
			<fileset dir="${buildDirectory}/${buildId}">
				<include name="**/org.eclipse.equinox.p2.generator.feature-${buildId}-linux.gtk.x86.zip" />
			</fileset>
		</path>
		<property name="feature.zip.name" refid="feature.zip.path" />
		<antcall target="extract">
			<param name="extract-src" value="${feature.zip.name}" />
			<param name="extract-dest" value="${prov.generator.dir}" />
		</antcall>
		<antcall target="extract">
			<param name="extract-src" value="${rcp.archive}" />
			<param name="extract-dest" value="${prov.generator.dir}" />
		</antcall>

		<chmod file="${prov.generator.dir}/eclipse/eclipse" perm="777" />
		<copy file="files/config.ini.generator" tofile="${prov.generator.dir}/eclipse/configuration/config.ini" overwrite="true" />
		<copy todir="${prov.generator.dir}/eclipse/plugins">
			<fileset dir="files">
				<include name="**/*.jar" />
			</fileset>
		</copy>

		<!-- prepare the agent -->
		<antcall target="extract">
			<param name="extract-src" value="${rcp.win32.archive}" />
			<param name="extract-dest" value="${prov.agent.dir}" />
		</antcall>
		<path id="agent.zip.path">
			<fileset dir="${buildDirectory}/${buildId}">
				<include name="**/org.eclipse.equinox.p2.agent.feature-*-win32.win32.x86.zip" />
			</fileset>
		</path>
		<property name="agent.zip.name" refid="agent.zip.path" />
		<antcall target="extract">
			<param name="extract-src" value="${agent.zip.name}" />
			<param name="extract-dest" value="${prov.agent.dir}" />
		</antcall>
		<copy file="files/config.ini.agent" tofile="${prov.agent.dir}/eclipse/configuration/config.ini" overwrite="true" />
		<copy todir="${prov.agent.dir}/eclipse/plugins">
			<fileset dir="files">
				<include name="**/*.jar" />
			</fileset>
		</copy>
		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="${prov.agent.dir}/eclipse/plugins" includes="**/org.eclipse.update.configurator_*" />
			<fileset dir="${prov.agent.dir}/eclipse/plugins" includes="**/org.eclipse.rcp_*" />
			<fileset dir="${prov.agent.dir}/eclipse/features" includes="**/*" />
		</delete>

		<!-- note: use the full path to the exe here, otherwise it seems to call the exe from the builder -->
		<exec executable="${prov.generator.dir}/eclipse/eclipse">
			<arg line="-vm ${java15-home}/bin/java" />
			<arg line="-application org.eclipse.equinox.p2.metadata.generator.EclipseGenerator" />
			<arg line="-consoleLog" />
			<arg line="-prov.os win32" />
			<arg line="-metadataRepository file:${prov.metadata.repo}" />
			<arg line="-artifactRepository file:${prov.artifact.repo}" />
			<arg line="-source ${prov.agent.dir}/eclipse" />
			<arg line="-rootVersion 0.1.0.${buildId}" />
			<arg line="-root agent" />
			<arg line="-flavor ${prov.flavor}" />
			<arg line="-publishArtifacts" />
		</exec>
	</target>

	<target name="generate.metadata.selfhosting">
		<path id="selfhosting.feature.zip.path">
			<fileset dir="${buildDirectory}/${buildId}">
				<include name="**/org.eclipse.equinox.p2.selfhosting.feature-${buildId}-win32.win32.x86.zip" />
			</fileset>
		</path>
		<property name="selfhosting.feature.zip.name" refid="selfhosting.feature.zip.path" />
		<property name="prov.selfhosting.dir" value="${prov.output.base}/selfhosting" />
		<antcall target="extract">
			<param name="extract-src" value="${selfhosting.feature.zip.name}" />
			<param name="extract-dest" value="${prov.selfhosting.dir}" />
		</antcall>

		<!-- note: use the full path to the exe here, otherwise it seems to call the exe from the builder -->
		<exec executable="${prov.generator.dir}/eclipse/eclipse">
			<arg line="-vm ${java15-home}/bin/java" />
			<arg line="-application org.eclipse.equinox.p2.metadata.generator.EclipseGenerator" />
			<arg line="-consoleLog" />
			<arg line="-nosplash" />
			<arg line="-prov.os win32" />
			<arg line="-base ${prov.selfhosting.dir}/eclipse" />
			<arg line="-features ${prov.selfhosting.dir}/eclipse/features" />
			<arg line="-bundles ${prov.selfhosting.dir}/eclipse/plugins" />
			<arg line="-rootVersion 0.1.0.${buildId}" />
			<arg line="-root selfhosting" />
			<arg line="-flavor ${prov.flavor}" />
			<arg line="-publishArtifacts" />
			<arg line="-metadataRepository file:${prov.metadata.repo}" />
			<arg line="-artifactRepository file:${prov.artifact.repo}" />
			<arg line="-noDefaultIUs" />
			<arg line="-append" />
		</exec>
	</target>

	<target name="generate.metadata.userUI">
		<path id="userui.feature.zip.path">
			<fileset dir="${buildDirectory}/${buildId}">
				<include name="**/org.eclipse.equinox.p2.user.ui.feature-${buildId}-win32.win32.x86.zip" />
			</fileset>
		</path>
		<property name="userui.feature.zip.name" refid="userui.feature.zip.path" />
		<property name="prov.userui.dir" value="${prov.output.base}/userui" />
		<antcall target="extract">
			<param name="extract-src" value="${userui.feature.zip.name}" />
			<param name="extract-dest" value="${prov.userui.dir}" />
		</antcall>

		<!-- note: use the full path to the exe here, otherwise it seems to call the exe from the builder -->
		<exec executable="${prov.generator.dir}/eclipse/eclipse">
			<arg line="-vm ${java15-home}/bin/java" />
			<arg line="-application org.eclipse.equinox.p2.metadata.generator.EclipseGenerator" />
			<arg line="-consoleLog" />
			<arg line="-nosplash" />
			<arg line="-prov.os win32" />
			<arg line="-base ${prov.userui.dir}/eclipse" />
			<arg line="-features ${prov.userui.dir}/eclipse/features" />
			<arg line="-bundles ${prov.userui.dir}/eclipse/plugins" />
			<arg line="-root userui" />
			<arg line="-rootVersion 0.1.0.${buildId}" />
			<arg line="-flavor ${prov.flavor}" />
			<arg line="-publishArtifacts" />
			<arg line="-metadataRepository file:${prov.metadata.repo}" />
			<arg line="-artifactRepository file:${prov.artifact.repo}" />
			<arg line="-noDefaultIUs" />
			<arg line="-append" />
		</exec>
	</target>

	<target name="generate.metadata.sdk">
		<property name="prov.sdk" value="${prov.output.base}/sdk" />
		<mkdir dir="${prov.sdk}" />
		<antcall target="extract">
			<param name="extract-src" value="${sdk.archive}" />
			<param name="extract-dest" value="${prov.sdk}" />
		</antcall>

		<!-- note: use the full path to the exe here, otherwise it seems to call the exe from the builder -->
		<exec executable="${prov.generator.dir}/eclipse/eclipse">
			<arg line="-vm ${java15-home}/bin/java" />
			<arg line="-application org.eclipse.equinox.p2.metadata.generator.EclipseGenerator" />
			<arg line="-consoleLog" />
			<arg line="-nosplash" />
			<arg line="-prov.os win32" />
			<arg line="-metadataRepository file:${prov.metadata.repo}" />
			<arg line="-artifactRepository file:${prov.artifact.repo}" />
			<arg line="-source ${prov.sdk}/eclipse" />
			<arg line="-rootVersion 3.4.0.${buildId}" />
			<arg line="-root sdk" />
			<arg line="-flavor ${prov.flavor}" />
			<arg line="-publishArtifacts" />
			<arg line="-append" />
		</exec>
	</target>

	<target name="run.director">
		<path id="director.zip.path">
			<fileset dir="${buildDirectory}/${buildId}">
				<include name="**/org.eclipse.equinox.p2.director.feature-${buildId}-linux.gtk.x86.zip" />
			</fileset>
		</path>
		<property name="director.zip.name" refid="director.zip.path" />
		<property name="prov.director.dir" value="${prov.output.base}/director" />
		<antcall target="extract">
			<param name="extract-src" value="${director.zip.name}" />
			<param name="extract-dest" value="${prov.director.dir}" />
		</antcall>
		<antcall target="extract">
			<param name="extract-src" value="${rcp.archive}" />
			<param name="extract-dest" value="${prov.director.dir}" />
		</antcall>
		<chmod file="${prov.director.dir}/eclipse/eclipse" perm="777" />
		<copy file="files/config.ini.director" tofile="${prov.director.dir}/eclipse/configuration/config.ini" overwrite="true" />
		<copy todir="${prov.director.dir}/eclipse/plugins">
			<fileset dir="files">
				<include name="**/*.jar" />
			</fileset>
		</copy>

		<!-- note: use the full path to the exe here, otherwise it seems to call the exe from the builder -->
		<exec executable="${prov.director.dir}/eclipse/eclipse">
			<arg line="-vm ${java15-home}/bin/java" />
			<arg line="-application org.eclipse.equinox.p2.director.app.application" />
			<arg line="-nosplash" />
			<arg line="-consoleLog" />
			<arg line="-flavor ${prov.flavor}" />
			<arg line="-installIU agent" />
			<arg line="-prov.os win32" />
			<arg line="-prov.ws win32" />
			<arg line="-prov.arch x86" />
			<arg line="-roaming" />
			<arg line="-profile EquinoxProvisioningUI" />
			<arg line="-metadataRepository file:${prov.metadata.repo}" />
			<arg line="-artifactRepository file:${prov.artifact.repo}" />
			<arg line="-destination ${prov.install.path}" />
			<arg line="-bundlepool ${prov.install.path}" />
			<arg line="-vmargs" />
			<arg line="-Declipse.p2.data.area=${prov.install.path}/configuration/org.eclipse.equinox.p2.core/agentdata" />
		</exec>

		<!-- Delete the other copy of ICU until bug 199299 is fixed -->
		<delete failonerror="false">
			<fileset dir="${prov.install.path}/plugins">
				<include name="**/com.ibm.icu_*.jar" />
			</fileset>
		</delete>

	</target>

	<target name="zip.install">
		<zip destfile="${prov.output.base}/equinox-prov-agent-${buildId}-win32.zip" basedir="${prov.install.folder.parent}" includes="${prov.install.folder}/**" />
		<copy file="${prov.output.base}/equinox-prov-agent-${buildId}-win32.zip" todir="${equinoxPostingDirectory}/${buildLabel}" />

		<zip destfile="${prov.output.base}/equinox-prov-servers-${buildId}.zip" basedir="${prov.repo.root}" includes="**/*" />

		<copy todir="${equinoxPostingDirectory}/${buildLabel}" file="${prov.output.base}/equinox-prov-servers-${buildId}.zip" />

		<copy todir="${equinoxPostingDirectory}/${buildLabel}">
			<fileset dir="${buildDirectory}/${buildId}">
				<include name="**/org.eclipse.equinox.p2.selfhosting.feature-${buildId}-win32.win32.x86.zip" />
				<include name="**/org.eclipse.equinox.p2.user.ui.feature-${buildId}-win32.win32.x86.zip" />
			</fileset>
		</copy>
	</target>


	<target name="extract">
		<!-- set the target based on which OS we are running on since there
		is a difference between unzip and untar/gunzip -->
		<condition property="extract.target" value="extract-zip">
			<contains string="${extract-src}" substring=".zip" />
		</condition>
		<condition property="extract.target" value="extract-tar.gz">
			<contains string="${extract-src}" substring=".tar.gz" />
		</condition>
		<antcall target="${extract.target}" />
	</target>

	<target name="extract-zip">
		<unzip src="${extract-src}" dest="${extract-dest}" />
	</target>

	<target name="extract-tar.gz">
		<exec dir="${extract-dest}" executable="tar">
			<arg line="-xzf ${extract-src}" />
		</exec>
	</target>

</project>

